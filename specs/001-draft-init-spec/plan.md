# Implementation Plan: spec-kit-docs

**Branch**: `001-draft-init-spec` | **Date**: 2025-10-13 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-draft-init-spec/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command following the spec-kit workflow.

## Summary

spec-kit-docsは、spec-kitプロジェクトのためのAI駆動型ドキュメント生成システムです。既存のspec-kitプロジェクトに拡張機能としてインストールし、`/speckit.doc-init`と`/speckit.doc-update`コマンドを提供します。SphinxまたはMkDocsのいずれかを選択してドキュメントプロジェクトを初期化し、specs/ディレクトリ内のspec.md、plan.md、tasks.mdから自動的にドキュメントを生成・更新します。

**技術アプローチ**:
- **CLI**: Typer（本家spec-kitと一貫）+ pyproject.toml + src-layout
- **テンプレート**: Jinja2 + importlib.resources（オフライン動作）
- **ドキュメント**: Sphinx (myst-parser) + MkDocs (Material theme)
- **変更検出**: GitPython（インクリメンタル更新）
- **テスト**: pytest + TDD (Red-Green-Refactor) + 90%カバレッジ

## Technical Context

**Language/Version**: Python 3.11+（spec-kit前提条件との互換性）
**Primary Dependencies**:
- CLI: `typer` (本家spec-kitと一貫), `click` (typer依存)
- Templates: `jinja2` (業界標準), `importlib.resources` (Python標準)
- Documentation: `sphinx`, `myst-parser` (Sphinx用), `mkdocs`, `mkdocs-material` (MkDocs用)
- Git: `GitPython` (変更検出)
- YAML: `ruamel.yaml` (MkDocs設定更新、コメント保持)
- Testing: `pytest`, `pytest-cov`, `pyfakefs` (ファイルシステムモック)

**Storage**: ファイルシステム（`docs/` ディレクトリ、`.specify/scripts/docs/`、`.claude/commands/`）
**Testing**: pytest + TDD (Red-Green-Refactor) + 90%カバレッジ目標 + contract tests
**Target Platform**: Linux/macOS（またはWSL2 on Windows）、spec-kit環境との一貫性
**Project Type**: single（CLIツール + ライブラリ）
**Performance Goals**:
- `/speckit.doc-init`: 30秒以内完了（対話的入力除く、SC-001）
- `/speckit.doc-update`: 45秒以内（10機能プロジェクト、SC-006）
- インクリメンタル更新: 5秒以内（1機能のみ変更時、90%削減）

**Constraints**:
- 非対話的実行必須（CI/CD対応、Constitution II）
- spec-kitパターン完全一貫（Constitution I）
- オフライン動作可能（importlib.resources使用）
- 既存ファイル上書き前の確認必須（`--force`でスキップ）

**Scale/Scope**:
- 想定プロジェクト規模: 1-20機能（MVP）、50機能まで最適化
- ドキュメントファイル: 機能あたり1-3ページ
- テンプレートファイル: 6-10ファイル（Sphinx + MkDocs）

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Critical Rules (C001-C014) ✓

- **C001 (ルール遵守)**: ✓ すべての設計決定は憲章に準拠
- **C002 (エラー迂回禁止)**: ✓ 明示的エラーハンドリング、ログファイル確認プロトコル
- **C003 (冒頭表示)**: ✓ 実装開始時に原則表示
- **C004 (理想実装ファースト)**: ✓ research.mdで理想的アプローチ選択、妥協なし
- **C005 (記録管理)**: ✓ research.md、data-model.md、contracts/で決定記録
- **C006 (堅牢コード品質)**: ✓ mypy --strict、ruff、black、90%カバレッジ
- **C007 (品質例外化禁止)**: ✓ MVP範囲内でも品質妥協なし
- **C008 (ドキュメント整合性)**: ✓ spec.md要件と完全整合
- **C009 (ブランチ必須)**: ✓ feature/001-draft-init-specブランチ使用
- **C010 (TDD必須)**: ✓ Red-Green-Refactorサイクル強制
- **C011 (データ正確性)**: ✓ 環境変数明示取得、フォールバック禁止
- **C012 (DRY原則)**: ✓ 本家spec-kitパターン再利用、事前調査必須
- **C013 (リファクタリング)**: ✓ V2クラス禁止、既存クラス修正優先
- **C014 (妥協実装禁止)**: ✓ 「とりあえず動く」実装禁止

### Core Principles ✓

**I. spec-kit Integration First**: ✓
- `specify init --here`パターン準拠（FR-021b）
- `/speckit.*`コマンド命名規則（FR-022）
- `specs/`ディレクトリ構造認識（FR-001）
- 本家spec-kitと一貫したエラーハンドリング（ベストエフォート、FR-023c）

**II. Non-Interactive Execution**: ✓
- すべてのスクリプトでinput()禁止（FR-003c）
- コマンドライン引数のみで動作（FR-003a, FR-003b）
- AIエージェントが対話担当（FR-003, FR-004）
- 決定的実行保証（同じ入力→同じ出力）

**III. Extensibility & Modularity**: ✓
- 抽象ベースクラス（generators/base.py）
- 独立モジュール（sphinx.py, mkdocs.py）
- 汎用コマンドテンプレート（AIエージェント非依存）
- パーサー/ジェネレータ分離

**IV. Incremental Delivery**: ✓
- MVP（P1）: US1（初期化）, US2（更新）, US3（インストール）
- P2: US4（統合機能）
- P3: US5（対象者別）, US6（バージョン履歴）

**V. Testability**: ✓
- TDD必須（C010準拠）
- 決定的入力/出力
- ファイルシステムモック（pyfakefs）
- 90%カバレッジ目標（SC-008準拠）

### Gate Status: **PASS** ✓

すべてのConstitution原則に準拠しています。Phase 0（Research）とPhase 1（Design）に進行可能です。

## Project Structure

### Documentation (this feature)

```
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```
src/speckit_docs/          # Main package (src-layout, PEP 517準拠)
├── __init__.py
├── models.py              # Data models (Feature, Section, GeneratorConfig等)
├── exceptions.py          # Custom exceptions (SpecKitDocsError)
├── cli/                   # CLI commands (typer)
│   ├── __init__.py
│   └── install_handler.py # speckit-docs install実装
├── generators/            # Documentation generators
│   ├── __init__.py
│   ├── base.py           # BaseGenerator抽象クラス
│   ├── sphinx.py         # SphinxGenerator実装
│   ├── mkdocs.py         # MkDocsGenerator実装
│   ├── document.py       # Document生成ロジック
│   ├── feature_page.py   # Feature page生成
│   └── navigation.py     # Navigation更新ロジック
├── parsers/              # Markdown parsers
│   ├── __init__.py
│   ├── markdown_parser.py # MarkdownParser (markdown-it-py)
│   ├── feature_scanner.py # FeatureScanner (specs/ディレクトリスキャン)
│   ├── document.py       # Document representation
│   └── document_structure.py # DocumentStructure detection
├── utils/                # Utilities
│   ├── __init__.py
│   ├── git.py           # Git操作 (GitPython)
│   ├── validation.py    # Validation utilities
│   ├── feature_discovery.py # Feature discovery
│   └── prompts.py       # Interactive prompts (for AIエージェント)
├── templates/            # Jinja2 templates (importlib.resources)
│   ├── sphinx/          # Sphinx templates
│   │   ├── conf.py.j2
│   │   ├── index.md.j2
│   │   ├── Makefile.j2
│   │   └── make.bat.j2
│   └── mkdocs/          # MkDocs templates
│       ├── mkdocs.yml.j2
│       └── index.md.j2
├── commands/             # Command templates (Claude Code用)
│   ├── speckit.doc-init.md
│   └── speckit.doc-update.md
└── scripts/              # Backend scripts (非対話的実行)
    ├── doc_init.py
    └── doc_update.py

tests/                     # Test suite (pytest + TDD)
├── unit/                  # Unit tests (90%カバレッジ目標)
│   ├── cli/
│   ├── generators/
│   ├── parsers/
│   ├── utils/
│   └── test_models.py
├── integration/           # Integration tests
│   ├── test_install.py
│   ├── test_sphinx_workflow.py
│   └── test_mkdocs_workflow.py
├── contract/              # Contract tests
│   └── test_doc_init_output.py
└── performance/           # Performance tests
    └── test_update_performance.py

pyproject.toml            # Project configuration (PEP 517, typer依存)
README.md                 # User documentation
CONTRIBUTING.md           # Developer documentation
```

**Structure Decision**: **Single project (CLIツール)**を選択

- **src-layout採用理由**: PEP 517標準準拠、テストの分離、importlib.resources互換
- **modularity重視**: generators/、parsers/、utils/の明確な分離（Constitution III）
- **templates/分離**: importlib.resourcesでアクセス、オフライン動作保証
- **TDD準拠**: tests/配下にunit/、integration/、contract/、performance/の4層構造（C010）

## Complexity Tracking

*Fill ONLY if Constitution Check has violations that must be justified*

**No violations**: すべての設計決定はConstitution原則に準拠しています。複雑さの正当化は不要です。

---

## Phase 0: Research ✓ COMPLETED

**成果物**: `research.md`（7つの技術的決定を調査）

**主要な決定**:
1. **R001: CLI Distribution** - Typer + pyproject.toml (本家spec-kitと一貫)
2. **R002: Template System** - Jinja2 + importlib.resources (オフライン動作)
3. **R003: Sphinx Integration** - myst-parser + Optional Extensions
4. **R004: MkDocs Config** - Material theme + ruamel.yaml
5. **R005: Git Detection** - GitPython + HEAD比較 + ハッシュキャッシュ
6. **R006: spec-kit Pattern** - `specify init --here`準拠
7. **R007: Testing** - pytest + TDD (Red-Green-Refactor) + 90%カバレッジ

**Constitution準拠**: C004（理想実装ファースト）、C006（堅牢コード品質）、C010（TDD必須）

---

## Phase 1: Design & Contracts ✓ COMPLETED

**成果物**:
- `data-model.md`（12エンティティ、5列挙型）
- `contracts/cli-interface.md`（CLI contract specification）
- `contracts/file-formats.md`（9ファイル形式仕様）
- `quickstart.md`（10-15分完了ガイド）

**主要なエンティティ**:
- Feature, Document, Section, DocumentStructure
- GeneratorConfig, BaseGenerator, SphinxGenerator, MkDocsGenerator
- ChangeDetector, MarkdownParser, BuildResult, ValidationResult

**Constitution準拠**: C006（型安全性）、C008（ドキュメント整合性）、C010（テスト可能設計）

---

## Next Steps

1. **Phase 2: Task Generation** - `/speckit.tasks`コマンドで`tasks.md`を生成
2. **Implementation** - TDD (Red-Green-Refactor)サイクルでタスク実行
3. **Testing** - 90%カバレッジ達成確認
4. **Documentation** - README.md、CONTRIBUTING.md更新

---

**Status**: **Phase 1 Complete** ✓
**Ready for**: `/speckit.tasks` command
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient] |
